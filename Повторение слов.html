<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>Викторина с крупным пропорциональным прогресс-баром</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background-color: #fffbea;
    padding: 40px 30px;
    color: #2f2f2f;
    font-size: 28px;
    max-width: 1000px;
    margin: 0 auto;
  }
  #header-title {
    text-align: center;
    margin-bottom: 30px;
    font-weight: 700;
    font-size: 36px;
  }
  .base-container {
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 20px;
  }
  .base-container label {
    min-width: 140px;
    font-weight: 600;
  }
  .base-container input[type="file"] {
    font-size: 18px;
  }
  .base-container button {
    font-size: 18px;
    padding: 8px 20px;
    cursor: pointer;
    border-radius: 12px;
    border: 2px solid #2f2f2f;
    background-color: #fffbea;
    font-weight: 600;
    transition: background-color 0.3s;
  }
  .base-container button:disabled {
    opacity: 0.5;
    cursor: default;
  }
  #progress-bar-container {
    width: 100%;
    height: 40px; /* увеличена высота */
    background-color: #ddd;
    border-radius: 20px; /* еще большее закругление */
    overflow: hidden;
    margin-bottom: 35px;
    display: none;
  }
  #progress-bar-fill {
    height: 100%;
    width: 0%;
    background-color: #ffcc00; /* жёлтый цвет */
    border-radius: 20px 0 0 20px;
    transition: width 0.3s ease;
  }
  #quiz-container {
    margin-top: 0;
  }
  #question {
    font-weight: 700;
    font-size: 48px;
    text-align: center;
    margin-bottom: 50px;
    line-height: 1.2;
  }
  #answers {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    grid-template-rows: repeat(3, auto);
    justify-content: center;
    gap: 30px 40px;
  }
  .answer-button {
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f8f7f9;
    border: 3px solid #c3c6d1;
    border-radius: 24px;
    padding: 24px 28px;
    font-size: 32px;
    cursor: pointer;
    font-weight: 600;
    text-align: center;
    direction: rtl;
    user-select: none;
    transition: background-color 0.3s, border-color 0.3s;
  }
  .answer-button.disabled {
    cursor: default;
    opacity: 0.7;
  }
  .answer-button.correct {
    background-color: #4caf50;
    border-color: #4caf50;
    color: white;
  }
  .answer-button.wrong {
    background-color: #f44336;
    border-color: #f44336;
    color: white;
  }
  #stats {
    margin-top: 40px;
    font-size: 26px;
    text-align: center;
    color: #555;
  }
  #level-passed {
    display: none;
    text-align: center;
  }
  #level-passed h2 {
    font-size: 40px;
    font-weight: 700;
    color: #4caf50;
  }
  #next-level-btn {
    margin-top: 30px;
    font-size: 24px;
    padding: 12px 40px;
    background-color: #4caf50;
    border: none;
    color: white;
    border-radius: 15px;
    cursor: pointer;
  }
  #back-to-selection {
    margin-top: 30px;
    display: block;
    font-size: 20px;
    padding: 10px 24px;
    cursor: pointer;
    border-radius: 12px;
    border: 2px solid #2f2f2f;
    background-color: #fffbea;
    font-weight: 600;
    margin-left: auto;
    margin-right: auto;
  }
</style>
</head>
<body>

<h2 id="header-title">Загрузка баз и запуск викторины</h2>

<div id="bases-container">
  <!-- 10 баз (см. ниже для id) -->
  <div class="base-container">
    <label for="file-input-1">База 1:</label>
    <input type="file" id="file-input-1" accept=".xlsx,.xls" />
    <button id="start-quiz-1" disabled>Начать викторину 1</button>
  </div>
  <!-- базы 2-10 по аналогии -->
  <div class="base-container">
    <label for="file-input-2">База 2:</label>
    <input type="file" id="file-input-2" accept=".xlsx,.xls" />
    <button id="start-quiz-2" disabled>Начать викторину 2</button>
  </div>
  <div class="base-container">
    <label for="file-input-3">База 3:</label>
    <input type="file" id="file-input-3" accept=".xlsx,.xls" />
    <button id="start-quiz-3" disabled>Начать викторину 3</button>
  </div>
  <div class="base-container">
    <label for="file-input-4">База 4:</label>
    <input type="file" id="file-input-4" accept=".xlsx,.xls" />
    <button id="start-quiz-4" disabled>Начать викторину 4</button>
  </div>
  <div class="base-container">
    <label for="file-input-5">База 5:</label>
    <input type="file" id="file-input-5" accept=".xlsx,.xls" />
    <button id="start-quiz-5" disabled>Начать викторину 5</button>
  </div>
  <div class="base-container">
    <label for="file-input-6">База 6:</label>
    <input type="file" id="file-input-6" accept=".xlsx,.xls" />
    <button id="start-quiz-6" disabled>Начать викторину 6</button>
  </div>
  <div class="base-container">
    <label for="file-input-7">База 7:</label>
    <input type="file" id="file-input-7" accept=".xlsx,.xls" />
    <button id="start-quiz-7" disabled>Начать викторину 7</button>
  </div>
  <div class="base-container">
    <label for="file-input-8">База 8:</label>
    <input type="file" id="file-input-8" accept=".xlsx,.xls" />
    <button id="start-quiz-8" disabled>Начать викторину 8</button>
  </div>
  <div class="base-container">
    <label for="file-input-9">База 9:</label>
    <input type="file" id="file-input-9" accept=".xlsx,.xls" />
    <button id="start-quiz-9" disabled>Начать викторину 9</button>
  </div>
  <div class="base-container">
    <label for="file-input-10">База 10:</label>
    <input type="file" id="file-input-10" accept=".xlsx,.xls" />
    <button id="start-quiz-10" disabled>Начать викторину 10</button>
  </div>
</div>

<div id="progress-bar-container">
  <div id="progress-bar-fill"></div>
</div>

<div id="quiz-container" style="display:none;">
  <div id="question"></div>
  <div id="answers"></div>
  <div id="stats"></div>
  <button id="back-to-selection">Вернуться к выбору базы</button>
</div>

<div id="level-passed" style="display:none;">
  <h2>Уровень пройден</h2>
  <button id="next-level-btn">Следующий уровень</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script>
const STORAGE_KEY = "persian_quiz_10_bases_with_levels";
const LEVEL_SIZE = 50;

const bases = {};
for (let i = 1; i <= 10; i++) {
  bases['base' + i] = {data: [], currentIndex: 0, correctCount: 0, shuffledOrder: [], levelProgress: 0};
}

let currentBaseKey = null;
let allowSelect = true;

function saveAllProgress() {
  const saveData = {};
  for (const key in bases) {
    saveData[key] = {
      data: bases[key].data,
      currentIndex: bases[key].currentIndex,
      correctCount: bases[key].correctCount,
      shuffledOrder: bases[key].shuffledOrder,
      levelProgress: bases[key].levelProgress
    };
  }
  localStorage.setItem(STORAGE_KEY, JSON.stringify(saveData));
}

function loadAllProgress() {
  const saved = localStorage.getItem(STORAGE_KEY);
  if (!saved) return;
  try {
    const obj = JSON.parse(saved);
    for (const key in bases) {
      if (obj[key]) {
        bases[key].data = obj[key].data || [];
        bases[key].currentIndex = obj[key].currentIndex || 0;
        bases[key].correctCount = obj[key].correctCount || 0;
        bases[key].shuffledOrder = obj[key].shuffledOrder || [];
        bases[key].levelProgress = obj[key].levelProgress || 0;
      }
    }
  } catch(e) {
    console.error('Ошибка загрузки прогресса:', e);
  }
}

function shuffle(array) {
  for(let i=array.length-1; i>0; i--) {
    let j = Math.floor(Math.random()*(i+1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

function createShuffledOrder(length) {
  let order = Array.from({ length }, (_, i) => i);
  shuffle(order);
  return order;
}

function createOptions(correctPersian) {
  const baseData = bases[currentBaseKey].data;
  let persians = baseData.map(x => x.persian).filter(p => p !== correctPersian);
  shuffle(persians);
  let options = persians.slice(0, 5);
  options.push(correctPersian);
  shuffle(options);
  return options;
}

function updateStats() {
  const progress = bases[currentBaseKey];
  document.getElementById('stats').textContent =
    `Вопрос ${progress.currentIndex + 1} из ${progress.data.length}. Правильных ответов: ${progress.correctCount}`;
}

function updateProgressBar(levelProgress) {
  const progressBarFill = document.getElementById('progress-bar-fill');
  const percent = (levelProgress / LEVEL_SIZE) * 100;
  progressBarFill.style.width = percent + '%';
}

function showQuestion() {
  const progress = bases[currentBaseKey];
  if (!progress.shuffledOrder || progress.shuffledOrder.length !== progress.data.length) {
    progress.shuffledOrder = createShuffledOrder(progress.data.length);
  }
  if (progress.currentIndex >= progress.data.length) {
    alert(`Викторина по базе ${currentBaseKey} закончена!\nПравильных ответов: ${progress.correctCount} из ${progress.data.length}.`);
    progress.currentIndex = 0;
    progress.correctCount = 0;
    progress.shuffledOrder = [];
    progress.levelProgress = 0;
    saveAllProgress();
    showSelection();
    return;
  }
  updateStats();
  allowSelect = true;
  updateProgressBar(progress.levelProgress);
  const questionIndex = progress.shuffledOrder[progress.currentIndex];
  const questionObj = progress.data[questionIndex];
  document.getElementById('question').textContent = questionObj.russian;
  const answersDiv = document.getElementById('answers');
  answersDiv.innerHTML = '';
  let options = createOptions(questionObj.persian);
  options.forEach((option) => {
    let btn = document.createElement('div');
    btn.classList.add('answer-button');
    btn.textContent = option;
    btn.onclick = () => {
      if (!allowSelect) return;
      allowSelect = false;
      if (option === questionObj.persian) {
        btn.classList.add('correct');
        progress.correctCount++;
        progress.levelProgress++;
        disableAllButtons(true);
        saveAllProgress();
        updateProgressBar(progress.levelProgress);
        if (progress.levelProgress >= LEVEL_SIZE) {
          setTimeout(() => {
            showLevelPassed();
          }, 700);
          return;
        }
        setTimeout(() => {
          progress.currentIndex++;
          saveAllProgress();
          showQuestion();
        }, 1000);
      } else {
        btn.classList.add('wrong');
        disableAllButtons(true);
        markCorrectOption(questionObj.persian);
        setTimeout(() => {
          clearButtonStyles();
          allowSelect = true;
        }, 2000);
      }
      updateStats();
      saveAllProgress();
    };
    answersDiv.appendChild(btn);
  });
  showQuiz();
}

function disableAllButtons(disable) {
  document.querySelectorAll('.answer-button').forEach(b => {
    b.style.pointerEvents = disable ? 'none' : 'auto';
    if (disable) b.classList.add('disabled');
    else b.classList.remove('disabled');
  });
}

function markCorrectOption(correctPersian) {
  document.querySelectorAll('.answer-button').forEach(b => {
    const text = b.textContent.trim();
    if (text === correctPersian) b.classList.add('correct');
  });
}

function clearButtonStyles() {
  document.querySelectorAll('.answer-button').forEach(b => {
    b.classList.remove('correct', 'wrong', 'disabled');
    b.style.pointerEvents = 'auto';
  });
}

function showSelection() {
  document.getElementById('header-title').style.display = 'block';
  document.getElementById('progress-bar-container').style.display = 'none';
  document.querySelectorAll('.base-container').forEach(c => c.style.display = 'flex');
  document.getElementById('quiz-container').style.display = 'none';
  document.getElementById('level-passed').style.display = 'none';
}

function showQuiz() {
  document.getElementById('header-title').style.display = 'none';
  document.getElementById('progress-bar-container').style.display = 'block';
  document.querySelectorAll('.base-container').forEach(c => c.style.display = 'none');
  document.getElementById('quiz-container').style.display = 'block';
  document.getElementById('level-passed').style.display = 'none';
}

function clearScreen() {
  document.getElementById('question').textContent = '';
  document.getElementById('answers').innerHTML = '';
  document.getElementById('stats').textContent = '';
}

function showLevelPassed() {
  document.getElementById('quiz-container').style.display = 'none';
  document.getElementById('level-passed').style.display = 'block';
}

document.getElementById('next-level-btn').addEventListener('click', () => {
  const progress = bases[currentBaseKey];
  progress.levelProgress = 0;
  progress.currentIndex++;
  saveAllProgress();
  showQuestion();
});

document.getElementById('back-to-selection').addEventListener('click', () => {
  showSelection();
  clearScreen();
});

function setupBase(baseId, inputId, buttonId) {
  const inp = document.getElementById(inputId);
  const btn = document.getElementById(buttonId);
  inp.addEventListener('change', () => {
    const file = inp.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      const dataXLSX = e.target.result;
      const workbook = XLSX.read(dataXLSX, {type:'binary'});
      const firstSheetName = workbook.SheetNames[0];
      const sheet = workbook.Sheets[firstSheetName];
      const jsonData = XLSX.utils.sheet_to_json(sheet, {header: 1});
      const newData = [];
      for(let i=0; i<jsonData.length; i++) {
        const row = jsonData[i];
        if(row.length >= 2) {
          newData.push({persian: row[0].toString().trim(), russian: row[1].toString().trim()});
        }
      }
      bases[baseId].data = newData;
      bases[baseId].currentIndex = 0;
      bases[baseId].correctCount = 0;
      bases[baseId].shuffledOrder = [];
      bases[baseId].levelProgress = 0;
      btn.disabled = false;
      saveAllProgress();
    };
    reader.readAsBinaryString(file);
  });
}

for(let i=1; i<=10; i++) {
  setupBase('base'+i, 'file-input-'+i, 'start-quiz-'+i);
  document.getElementById('start-quiz-'+i).addEventListener('click', () => {
    currentBaseKey = 'base'+i;
    createProgressBar();
    showQuestion();
  });
}

function createProgressBar() {
  updateProgressBar(0);
}

window.addEventListener('load', () => {
  loadAllProgress();
  for(let i=1; i<=10; i++) {
    const btn = document.getElementById('start-quiz-'+i);
    btn.disabled = !bases['base'+i].data.length;
  }
  document.getElementById('progress-bar-container').style.display ='none';
});
</script>

</body>
</html>
